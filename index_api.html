<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestor Financeiro (API)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, sans-serif; background:#f7f9fc; }
    .tab-button { transition: all .15s; }
    .action-icon { cursor:pointer; padding:4px; border-radius:6px; }
    .action-icon:hover { background:rgba(0,0,0,.06); }
  </style>
</head>
<body class="p-4 sm:p-8">
  <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6">
    <h1 class="text-2xl font-bold text-gray-800 mb-4">üí∏ Gestor Financeiro</h1>
    
    <!-- Auth Section -->
    <div id="authSection" class="mb-6 p-4 bg-gray-50 rounded-lg border">
      <div id="notLoggedIn" class="hidden">
        <p class="text-sm text-gray-600 mb-2">Fa√ßa login para usar o sistema</p>
        <button id="loginBtn" class="px-4 py-2 bg-blue-600 text-white rounded font-semibold hover:bg-blue-700">
          <svg class="inline w-5 h-5 mr-2" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Login com Google
        </button>
      </div>
      <div id="loggedIn" class="hidden flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img id="userPicture" class="w-10 h-10 rounded-full" />
          <div>
            <p class="font-semibold text-gray-800" id="userName"></p>
            <p class="text-xs text-gray-500" id="userEmail"></p>
          </div>
        </div>
        <button id="logoutBtn" class="px-3 py-1 bg-gray-400 text-white text-sm rounded hover:bg-gray-500">Sair</button>
      </div>
    </div>
    
    <div class="flex items-end gap-4 mb-6 flex-wrap" id="userIdSection" style="display:none">
      <div>
        <label class="text-xs font-semibold text-gray-600">User ID</label>
        <input id="userIdInput" type="text" value="demo" class="mt-1 px-2 py-1 border rounded w-40 text-sm" readonly />
      </div>
      <button id="importButton" class="h-9 px-4 bg-pink-600 text-white rounded text-sm font-semibold hover:bg-pink-700">Importar Extrato Simulado</button>
      <button id="syncOFButton" class="h-9 px-4 bg-emerald-600 text-white rounded text-sm font-semibold hover:bg-emerald-700">Sincronizar Open Finance</button>
      <span id="status" class="text-xs text-gray-500">Pronto</span>
    </div>

    <div id="dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-green-100 p-4 rounded-lg border-l-4 border-green-500">
        <p class="text-sm text-gray-600">Receitas Totais</p>
        <p id="totalIncome" class="text-2xl font-bold text-green-700 mt-1">R$ 0,00</p>
      </div>
      <div class="bg-red-100 p-4 rounded-lg border-l-4 border-red-500">
        <p class="text-sm text-gray-600">Despesas Totais</p>
        <p id="totalExpense" class="text-2xl font-bold text-red-700 mt-1">R$ 0,00</p>
      </div>
      <div class="bg-blue-100 p-4 rounded-lg border-l-4 border-blue-500">
        <p class="text-sm text-gray-600">Saldo Atual</p>
        <p id="currentBalance" class="text-2xl font-bold text-blue-700 mt-1">R$ 0,00</p>
      </div>
    </div>

    <div class="flex border-b mb-4">
      <button id="tabTransacoes" class="tab-button px-4 py-2 text-sm font-semibold border-b-2 border-indigo-500 text-indigo-600" onclick="showTab('transacoes')">Transa√ß√µes</button>
      <button id="tabParcelas" class="tab-button px-4 py-2 text-sm font-semibold border-b-2 border-transparent text-gray-500" onclick="showTab('parcelas')">Parcelas</button>
    </div>

    <div id="contentTransacoes">
      <h2 class="text-lg font-semibold mb-3">Novo Lan√ßamento</h2>
      <form id="transactionForm" class="grid grid-cols-1 sm:grid-cols-3 gap-4 bg-gray-50 p-4 rounded-lg mb-4">
        <div>
          <label class="text-xs font-semibold">Descri√ß√£o</label>
          <input id="descricaoTransacao" required class="mt-1 w-full p-2 border rounded" />
        </div>
        <div>
          <label class="text-xs font-semibold">Valor (R$)</label>
          <input id="valorTransacao" type="number" step="0.01" required class="mt-1 w-full p-2 border rounded" />
        </div>
        <div>
          <label class="text-xs font-semibold">Tipo</label>
          <select id="tipoTransacao" class="mt-1 w-full p-2 border rounded">
            <option value="income">Receita</option>
            <option value="expense">Despesa</option>
          </select>
        </div>
        <div class="sm:col-span-3">
          <button class="w-full bg-indigo-600 text-white py-2 rounded font-semibold hover:bg-indigo-700">Adicionar</button>
        </div>
      </form>
      <h3 class="text-md font-semibold mb-2">Hist√≥rico</h3>
      <div id="transactionList" class="space-y-2"></div>
    </div>

    <div id="contentParcelas" class="hidden">
      <h2 class="text-lg font-semibold mb-3">Nova Parcela</h2>
      <form id="installmentForm" class="grid grid-cols-1 sm:grid-cols-4 gap-4 bg-gray-50 p-4 rounded-lg mb-4">
        <div class="sm:col-span-2">
          <label class="text-xs font-semibold">Descri√ß√£o</label>
          <input id="descricaoParcela" required class="mt-1 w-full p-2 border rounded" />
        </div>
        <div>
          <label class="text-xs font-semibold">Valor Mensal (R$)</label>
          <input id="valorMensalParcela" type="number" step="0.01" required class="mt-1 w-full p-2 border rounded" />
        </div>
        <div>
          <label class="text-xs font-semibold">Meses</label>
          <input id="totalMesesParcela" type="number" required class="mt-1 w-full p-2 border rounded" />
        </div>
        <div class="sm:col-span-4">
          <button class="w-full bg-indigo-600 text-white py-2 rounded font-semibold hover:bg-indigo-700">Adicionar</button>
        </div>
      </form>
      <h3 class="text-md font-semibold mb-2">Parcelas Ativas</h3>
      <div id="installmentList" class="space-y-2"></div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let userId = 'demo';
    let transactions = [];
    let installments = [];

    const statusEl = document.getElementById('status');
    const formatCurrency = v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);
    const apiBase = () => `http://localhost:5000/api/users/${encodeURIComponent(userId)}`;

    async function checkAuth() {
      try {
        const res = await fetch('http://localhost:5000/auth/me', { credentials: 'include' });
        if (res.ok) {
          currentUser = await res.json();
          userId = currentUser.user_id;
          document.getElementById('notLoggedIn').classList.add('hidden');
          document.getElementById('loggedIn').classList.remove('hidden');
          document.getElementById('userPicture').src = currentUser.picture;
          document.getElementById('userName').textContent = currentUser.name;
          document.getElementById('userEmail').textContent = currentUser.email;
          document.getElementById('userIdInput').value = currentUser.user_id;
          document.getElementById('userIdSection').style.display = '';
          await loadAll();
        } else {
          document.getElementById('notLoggedIn').classList.remove('hidden');
          document.getElementById('loggedIn').classList.add('hidden');
          document.getElementById('userIdSection').style.display = 'none';
        }
      } catch (error) {
        console.error('Erro ao verificar autentica√ß√£o:', error);
        document.getElementById('notLoggedIn').classList.remove('hidden');
        document.getElementById('loggedIn').classList.add('hidden');
      }
    }

    document.getElementById('loginBtn').addEventListener('click', () => {
      window.location.href = 'http://localhost:5000/auth/login';
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('http://localhost:5000/auth/logout', { credentials: 'include' });
      currentUser = null;
      window.location.reload();
    });

    async function api(path, options={}){
      try {
        const res = await fetch(apiBase()+path, {headers:{'Content-Type':'application/json'}, credentials: 'include', ...options});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch(err){ console.error(err); statusEl.textContent='Erro'; throw err; }
    }

    async function loadAll(){
      if (!currentUser) return;
      statusEl.textContent='Carregando...';
      try {
        [transactions, installments] = await Promise.all([
          api('/transactions'),
          api('/installments')
        ]);
        const summary = await api('/summary');
        renderSummary(summary);
        renderTransactions();
        renderInstallments();
        statusEl.textContent='OK';
      } catch { statusEl.textContent='Falhou'; }
    }

    function renderSummary(s){
      document.getElementById('totalIncome').textContent = formatCurrency(s.income);
      document.getElementById('totalExpense').textContent = formatCurrency(s.expenses_total);
      const bal = document.getElementById('currentBalance');
      bal.textContent = formatCurrency(s.balance);
      bal.classList.remove('text-green-700','text-red-700','text-blue-700');
      bal.classList.add(s.balance>0?'text-green-700':(s.balance<0?'text-red-700':'text-blue-700'));
    }

    function renderTransactions(){
      const list=document.getElementById('transactionList'); list.innerHTML='';
      if(!transactions.length){ list.innerHTML='<p class="text-xs text-gray-500 italic">Nenhuma transa√ß√£o.</p>'; return; }
      [...transactions].sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(t=>{
        const div=document.createElement('div');
        const isIncome=t.type==='income';
        div.className=`flex justify-between items-center p-3 rounded border ${isIncome?'bg-green-50':'bg-red-50'}`;
        div.innerHTML=`<div><p class='font-semibold'>${t.description}</p><p class='text-xs text-gray-500'>${new Date(t.date).toLocaleDateString('pt-BR')}</p></div>
          <div class='flex items-center'>
            <span class='font-bold ${isIncome?'text-green-600':'text-red-600'}'>${formatCurrency(t.amount)}</span>
            <span class='action-icon ml-2' onclick="editTransaction(${t.id}, '${t.description.replace(/'/g,"&#39;")}', ${t.amount}, '${t.type}')" title='Editar'>‚úèÔ∏è</span>
            <span class='action-icon ml-1' onclick="deleteTransaction(${t.id})" title='Remover'>üóëÔ∏è</span>
          </div>`;
        list.appendChild(div);
      });
    }

    function renderInstallments(){
      const list=document.getElementById('installmentList'); list.innerHTML='';
      if(!installments.length){ list.innerHTML='<p class="text-xs text-gray-500 italic">Nenhuma parcela.</p>'; return; }
      installments.forEach(i=>{
        const total=i.monthly_value*i.total_months;
        const div=document.createElement('div');
        div.className='flex justify-between items-center p-3 rounded border bg-yellow-50';
        div.innerHTML=`<div><p class='font-semibold'>${i.description}</p><p class='text-xs text-gray-600'>Mensal: ${formatCurrency(i.monthly_value)} | Total ${i.total_months}x (${formatCurrency(total)})</p></div>
          <div class='flex items-center'>
            <span class='action-icon ml-2' onclick="editInstallment(${i.id}, '${i.description.replace(/'/g,"&#39;")}', ${i.monthly_value}, ${i.total_months})" title='Editar'>‚úèÔ∏è</span>
            <span class='action-icon ml-1' onclick="deleteInstallment(${i.id})" title='Remover'>üóëÔ∏è</span>
          </div>`;
        list.appendChild(div);
      });
    }

    window.editTransaction = async (id, desc, amount, type)=>{
      const nd=prompt('Descri√ß√£o:', desc); if(nd===null) return;
      const na=prompt('Valor:', amount); if(na===null) return;
      const nt=prompt('Tipo (income/expense):', type); if(nt===null) return;
      await api(`/transactions/${id}`, {method:'PATCH', body:JSON.stringify({description:nd, amount:na, type:nt})});
      loadAll();
    };
    window.deleteTransaction = async (id)=>{ if(!confirm('Remover transa√ß√£o?')) return; await api(`/transactions/${id}`,{method:'DELETE'}); loadAll(); };

    window.editInstallment = async (id, desc, monthly, months)=>{
      const nd=prompt('Descri√ß√£o:', desc); if(nd===null) return;
      const nm=prompt('Valor Mensal:', monthly); if(nm===null) return;
      const nt=prompt('Meses:', months); if(nt===null) return;
      await api(`/installments/${id}`, {method:'PATCH', body:JSON.stringify({description:nd, monthly_value:nm, total_months:nt})});
      loadAll();
    };
    window.deleteInstallment = async (id)=>{ if(!confirm('Remover parcela?')) return; await api(`/installments/${id}`,{method:'DELETE'}); loadAll(); };

    document.getElementById('transactionForm').addEventListener('submit', async e => {
      e.preventDefault();
      const description=document.getElementById('descricaoTransacao').value.trim();
      const amount=parseFloat(document.getElementById('valorTransacao').value);
      const type=document.getElementById('tipoTransacao').value;
      if(!description || !(amount>0)) return alert('Dados inv√°lidos');
      await api('/transactions',{method:'POST', body:JSON.stringify({description, amount, type})});
      e.target.reset(); loadAll();
    });

    document.getElementById('installmentForm').addEventListener('submit', async e => {
      e.preventDefault();
      const description=document.getElementById('descricaoParcela').value.trim();
      const monthly_value=parseFloat(document.getElementById('valorMensalParcela').value);
      const total_months=parseInt(document.getElementById('totalMesesParcela').value,10);
      if(!description || !(monthly_value>0) || !(total_months>0)) return alert('Dados inv√°lidos');
      await api('/installments',{method:'POST', body:JSON.stringify({description, monthly_value, total_months})});
      e.target.reset(); loadAll();
    });

    document.getElementById('importButton').addEventListener('click', async ()=>{ await api('/import',{method:'POST'}); loadAll(); });
    const syncBtn = document.getElementById('syncOFButton');
    if (syncBtn) {
      syncBtn.addEventListener('click', async ()=>{
        statusEl.textContent='Sincronizando...';
        try {
          await api('/openfinance/sync', {method:'POST'});
          await loadAll();
          statusEl.textContent='Sincronizado';
        } catch {
          statusEl.textContent='Falhou';
        }
      });
    }

    window.showTab = (tab) => {
      ['Transacoes','Parcelas'].forEach(n=>{
        document.getElementById('tab'+n).classList.remove('border-indigo-500','text-indigo-600');
        document.getElementById('tab'+n).classList.add('border-transparent','text-gray-500');
        document.getElementById('content'+n).classList.add('hidden');
      });
      document.getElementById('tab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('border-indigo-500','text-indigo-600');
      document.getElementById('tab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.remove('border-transparent','text-gray-500');
      document.getElementById('content'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.remove('hidden');
    };

    showTab('transacoes');
    checkAuth();
  </script>
</body>
</html>